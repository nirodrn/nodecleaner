import PySimpleGUI as sg
import threading
import os
import sys
from pathlib import Path
import time

# Import logic from the main script
# Ensure node_modules_cleaner.py is in the same directory
try:
    import node_modules_cleaner as core
except ImportError:
    sg.popup_error("Error: Could not import 'node_modules_cleaner.py'.\nMake sure both scripts are in the same folder.")
    sys.exit(1)

# Global state for threads
found_folders = []
is_scanning = False
is_deleting = False
stop_event = threading.Event()

def scan_thread(window, path_str):
    global found_folders, is_scanning
    is_scanning = True
    found_folders = []
    
    window.write_event_value('-LOG-', f"Scanning started for: {path_str}\n")
    
    try:
        # Use the generator from core script
        count = 0
        for folder in core.scan_directories(path_str):
            if stop_event.is_set():
                break
            found_folders.append(folder)
            count += 1
            # Update log periodically to avoid flooding GUI event queue too fast
            window.write_event_value('-LOG-', f"[FOUND] {folder}\n")
            
        window.write_event_value('-SCAN-DONE-', count)
    except Exception as e:
        window.write_event_value('-LOG-', f"Error during scan: {e}\n")
    finally:
        is_scanning = False

def delete_thread(window):
    global is_deleting
    is_deleting = True
    total = len(found_folders)
    deleted = 0
    
    window.write_event_value('-LOG-', f"\nStarting deletion of {total} folders...\n")
    
    for i, folder in enumerate(found_folders):
        if stop_event.is_set():
            break
            
        window.write_event_value('-LOG-', f"Deleting: {folder}\n")
        if core.delete_directory(folder):
            deleted += 1
        else:
            window.write_event_value('-LOG-', f"[FAILED] Could not delete: {folder}\n")
            
        # Update progress
        progress = int(((i + 1) / total) * 100)
        window.write_event_value('-PROGRESS-', progress)
        
    window.write_event_value('-DELETE-DONE-', deleted)
    is_deleting = False

def main():
    global stop_event
    
    sg.theme('DarkBlue3')

    layout = [
        [sg.Text("Node Modules Cleaner", font=("Helvetica", 16))],
        [sg.Text("Target Folder:"), sg.Input(key='-PATH-', expand_x=True), sg.FolderBrowse()],
        [
            sg.Button("Scan", key='-SCAN-', size=(10, 1)), 
            sg.Button("Delete All", key='-DELETE-', disabled=True, size=(10, 1), button_color=('white', 'red')),
            sg.Button("Exit", size=(10, 1))
        ],
        [sg.Text("Progress:"), sg.ProgressBar(100, orientation='h', size=(20, 20), key='-PROG-', expand_x=True)],
        [sg.Multiline(size=(60, 15), key='-LOG-', autoscroll=True, disabled=True, expand_x=True, expand_y=True)],
        [sg.Text("Ready", key='-STATUS-', size=(40, 1))]
    ]

    window = sg.Window("Node Modules Cleaner GUI", layout, resizable=True)

    while True:
        event, values = window.read()

        if event in (sg.WIN_CLOSED, "Exit"):
            if is_scanning or is_deleting:
                if sg.popup_yes_no("Operation in progress. Stop and exit?") == 'Yes':
                    stop_event.set()
                    break
            else:
                break

        if event == '-SCAN-':
            path_str = values['-PATH-']
            if not path_str:
                sg.popup_error("Please select a folder first.")
                continue
                
            if not os.path.exists(path_str):
                sg.popup_error("Path does not exist.")
                continue

            # Safety Check
            if core.is_system_drive(path_str):
                sg.popup_error("SAFETY ALERT: You selected the System Drive root.\nScanning the entire system drive is restricted.\nPlease select a specific folder.")
                continue

            # Reset UI
            window['-LOG-'].update("")
            window['-PROG-'].update(0)
            window['-DELETE-'].update(disabled=True)
            window['-STATUS-'].update("Scanning...")
            window['-SCAN-'].update(disabled=True)
            
            stop_event.clear()
            threading.Thread(target=scan_thread, args=(window, path_str), daemon=True).start()

        # Handle Thread Events
        if event == '-LOG-':
            # Append text to multiline
            text = values[event]
            window['-LOG-'].update(text, append=True)

        if event == '-SCAN-DONE-':
            count = values[event]
            window['-STATUS-'].update(f"Scan complete. Found {count} folders.")
            window['-SCAN-'].update(disabled=False)
            if count > 0:
                window['-DELETE-'].update(disabled=False)
            else:
                sg.popup("No node_modules folders found.")

        if event == '-DELETE-':
            count = len(found_folders)
            if sg.popup_yes_no(f"WARNING: Are you sure you want to delete {count} folders?\nThis cannot be undone.") == 'Yes':
                window['-SCAN-'].update(disabled=True)
                window['-DELETE-'].update(disabled=True)
                window['-STATUS-'].update("Deleting...")
                
                stop_event.clear()
                threading.Thread(target=delete_thread, args=(window,), daemon=True).start()

        if event == '-PROGRESS-':
            progress = values[event]
            window['-PROG-'].update(progress)

        if event == '-DELETE-DONE-':
            deleted_count = values[event]
            window['-STATUS-'].update(f"Deletion complete. Removed {deleted_count} folders.")
            window['-SCAN-'].update(disabled=False)
            window['-DELETE-'].update(disabled=True)
            sg.popup(f"Operation complete.\nDeleted: {deleted_count}")

    window.close()

if __name__ == "__main__":
    main()
